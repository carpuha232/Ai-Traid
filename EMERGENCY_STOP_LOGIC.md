# 🚨 EMERGENCY STOP @ ROI -85% - ЛОГИКА РАБОТЫ

## 📊 **ОБЩАЯ СХЕМА ЗАЩИТЫ**

```
                    PROGRESSIVE STOP (трейлинг в прибыли)
                    ═══════════════════════════════════════
ROI +200% ─────────────────────────────── Stop @ +180%
ROI +120% ─────────────────────────────── Stop @ +100%
ROI +100% ─────────────────────────────── Stop @ +90%
ROI +50%  ─────────────────────────────── Stop @ +40%
ROI +30%  ─────────────────────────────── Stop @ +20%
ROI +20%  ─────────────────────────────── Stop @ +10% ✅ АКТИВАЦИЯ

─────────────────────────────────────────────────────────
ROI +10%  (без защиты)
ROI  0%   ━━━━━━━━━━━ ВХОД В СДЕЛКУ ━━━━━━━━━━━━━━━━━
ROI -10%  🛡️ EMERGENCY STOP @ -85% + Averaging @ 15%
ROI -50%  🛡️ EMERGENCY STOP @ -85% + Averaging @ 15%
ROI -85%  🚨 EMERGENCY СРАБАТЫВАЕТ (закрытие позиции)
─────────────────────────────────────────────────────────
ROI -100% ☠️ ЛИКВИДАЦИЯ (если emergency не сработал)
```

---

## 🎯 **ТРИ РЕЖИМА ЗАЩИТЫ**

### **MODE 1: LOSS (ROI < 0%)**
**Цель:** Предотвратить ликвидацию + попытка восстановления

**Активные защиты:**
- 🚨 **EMERGENCY STOP** @ ROI -85% (спасает 15% маржи)
- 📊 **AVERAGING ORDER** @ 15% от ликвидации (доливка для восстановления)

**Действия:**
1. ✅ Ставится emergency stop сразу при открытии позиции
2. ✅ Активна доливка на 15% от ликвидации
3. ✅ При возврате к ROI ≥ 0% → emergency stop отменяется

**Пример (SHORT @ 102,187 с плечом 50x):**
```
Entry:       102,187.80  (ROI 0%)
Liquidation: 100,603.46  (ROI -100%)

Emergency Stop Price:
ROI -85% → price_change = -85% / 50 = -1.7%
Price = 102,187.80 × (1 + 0.017) = 103,924.99

🚨 Emergency stop @ 103,924.99 (ROI -85%)
📊 Averaging @ 15% от ликвидации
☠️ Liquidation @ 100,603.46 (ROI -100%)
```

---

### **MODE 2: SMALL PROFIT (0% ≤ ROI < 20%)**
**Цель:** Минимальная защита, ожидание активации прогрессивного стопа

**Активные защиты:**
- ❌ НЕТ (зона свободного движения)

**Действия:**
1. ✅ Averaging отменяется (позиция в прибыли)
2. ✅ Emergency stop отменяется (ROI > 0%)
3. ⏳ Ожидание ROI +20% для активации progressive stop

**Логика:**
```
ROI 0-20%: Даем позиции "подышать"
- Если вернется в минус → emergency stop снова активируется
- Если дойдет до +20% → progressive stop активируется
```

---

### **MODE 3: PROGRESSIVE STOP (ROI ≥ 20%)**
**Цель:** Максимизация прибыли с трейлинг-защитой

**Активные защиты:**
- 📈 **PROGRESSIVE STOP** (трейлинг стоп)

**Действия:**
1. ✅ Emergency stop отменен (не нужен)
2. ✅ Averaging отменен навсегда
3. ✅ Активен прогрессивный стоп с шагом 10% (до 100%) и 20% (после 100%)

**Логика progressive stop:**
```python
if ROI >= 20%:
    stop_at = 10%   # +20% → стоп @ +10%

if ROI >= 30%:
    stop_at = 20%   # +30% → стоп @ +20%

if ROI >= 100%:
    stop_at = 90%   # +100% → стоп @ +90%

if ROI >= 120%:
    stop_at = 100%  # +120% → стоп @ +100% (шаг 20%)
```

---

## 💡 **КЛЮЧЕВЫЕ МОМЕНТЫ**

### **1. Emergency Stop vs Progressive Stop**
| Параметр | Emergency Stop | Progressive Stop |
|----------|----------------|------------------|
| **Когда** | ROI < 0% | ROI ≥ 20% |
| **Уровень** | ROI -85% (фиксированный) | ROI +10%, +20%, +30%... (трейлинг) |
| **Цель** | Предотвратить ликвидацию | Максимизировать прибыль |
| **Расчет** | От entry_price по ROI | От entry_price по ROI |

### **2. Логика включения/отключения**
```
Открытие позиции:
└─> 🚨 Emergency @ -85% активен
└─> 📊 Averaging @ 15% активен

ROI переходит > 0%:
└─> ✅ Emergency отменяется
└─> ✅ Averaging отменяется

ROI возвращается < 0%:
└─> 🚨 Emergency ставится снова
└─> 📊 Averaging активен снова

ROI достигает ≥ 20%:
└─> 📈 Progressive stop активируется @ +10%
└─> ✅ Emergency окончательно отменен
└─> ✅ Averaging окончательно отменен
```

### **3. Безопасность размещения ордеров**
```python
# ВСЕГДА: новый ордер СНАЧАЛА, старый потом
new_order = place_order(new_level)
if new_order:
    cancel_order(old_order)  # Отменить старый ПОСЛЕ успешного размещения нового
```

---

## 🔧 **КОНФИГУРАЦИЯ**

### **config.json**
```json
"risk": {
  "emergency_stop_enabled": true,        // Включить emergency stop
  "emergency_stop_roi_level": -85.0,     // Уровень срабатывания (ROI -85%)
  "emergency_stop_activation_roi": 0.0,  // Активация при ROI ≤ 0%
  "emergency_stop_cancel_roi": 0.0,      // Отмена при ROI > 0%
  
  "averaging_down_enabled": true,
  "averaging_trigger_distance_from_liq": 15.0,  // 15% от ликвидации
  
  "stepped_stop_enabled": true,          // Progressive stop
  "stepped_stop_activation_pnl": 10.0    // Активация при +20% (стоп @ +10%)
}
```

---

## 📈 **ПРИМЕРЫ РАБОТЫ**

### **Пример 1: Убыточная сделка с восстановлением**
```
1. Открытие SHORT @ 102,187 (ROI 0%)
   🚨 Emergency stop @ 103,925 (ROI -85%)
   📊 Averaging активен

2. Цена выросла до 102,500 (ROI -15%)
   🚨 Emergency stop активен
   📊 Averaging активен

3. Цена упала до 101,900 (ROI +14%)
   ✅ Emergency stop отменен
   ✅ Averaging отменен
   ⏳ Ждем ROI +20%

4. Цена упала до 101,500 (ROI +33%)
   📈 Progressive stop @ +20% (101,684)
```

### **Пример 2: Резкое движение против позиции**
```
1. Открытие LONG @ 100,000 (ROI 0%)
   🚨 Emergency stop @ 98,300 (ROI -85%)

2. ⚡ Резкий дамп до 98,500 (ROI -75%)
   🚨 Emergency stop все еще активен

3. ⚡ Дамп до 98,200 (ROI -90%)
   🚨 EMERGENCY СРАБАТЫВАЕТ @ 98,300
   ✅ Позиция закрыта с потерей 85% маржи
   ✅ Спасено 15% маржи (вместо 100% ликвидации)
```

### **Пример 3: Успешная сделка с прогрессивным стопом**
```
1. Открытие LONG @ 100,000 (ROI 0%)
   🚨 Emergency stop @ 98,300 (ROI -85%)

2. Цена выросла до 100,400 (ROI +20%)
   ✅ Emergency отменен
   📈 Progressive stop @ +10% (100,200)

3. Цена выросла до 100,600 (ROI +30%)
   📈 Progressive stop обновлен @ +20% (100,400)

4. Цена выросла до 102,000 (ROI +100%)
   📈 Progressive stop @ +90% (101,800)

5. Цена откатила до 101,800
   🎯 Progressive stop сработал @ ROI +90%
```

---

## ✅ **ИТОГИ**

### **Что реализовано:**
1. ✅ Emergency stop @ ROI -85% для защиты от ликвидации
2. ✅ Автоматическая активация при ROI ≤ 0%
3. ✅ Автоматическая отмена при ROI > 0%
4. ✅ Размещение при открытии позиции
5. ✅ Реактивация при возврате в убыток
6. ✅ Интеграция с averaging и progressive stop
7. ✅ Три режима защиты (Loss / Small Profit / Progressive)

### **Защищает от:**
- ⚡ Резких движений цены (gap, новости)
- ⚡ Полной ликвидации (спасает 15% маржи)
- ⚡ Отключения бота
- ⚡ Сетевых задержек
- ⚡ Проблем с биржей

### **Результат:**
```
БЕЗ emergency stop:  Потеря 100% маржи при ликвидации
С emergency stop:    Потеря максимум 85% маржи, спасли 15%
```

---

**🚀 СИСТЕМА ГОТОВА К РАБОТЕ!**





